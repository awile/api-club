# 5. Database Migrations


### Table of Contents
1. [Install Alembic](#install-alembic)
2. [Initialize Alembic](#initialize-alembic)
3. [Create a model](#create-a-model)
4. [Connect alembic and sqlalchemy](#connect-alembic-and-sqlalchemy)
5. [Create a migration](#create-a-migration)
6. [Run a migration](#run-a-migration)
7. [Challenge](#challenge)


### Install Alembic
Alembic is a database migration tool for SQLAlchemy. It provides a way to manage our database schema and can automatically detect changes to our database models defined in python code.

Let's add alembic to our `requirements.txt` then run `pip install -r requirements.txt` to install it:
```bash
alembic~=1.13.2
```

### Initialize Alembic
To setup alembic in our repo we will first run the init command with the flag `--async` since we have an asynchronous database connection (more on this in future steps).
```bash
alembic init -t async app/alembic
```

This will create a file called `alembic.ini` for configuration and a directory at `app/alembic` that will contain our migration scripts and some more configuration files.


### Create a model
We want to setup a sqlalchemy model that will be used to create a database table and interact with the database in our application.

1. First we create a file `app/models/base.py` to contain our base model class.

```python
from sqlalchemy.orm import DeclarativeBase

class Base(DeclarativeBase):
    type_annotation_map = {}
```
This will allow us to use the `Base` class to define our database models.
Alembic will also use this to detect model changes and create migration scripts.


2. Create a database model
To do this we will create a `models/task.py` file:
```python
import uuid
from datetime import datetime

from app.models.base import Base
from sqlalchemy import Integer, DateTime, String
from sqlalchemy.orm import Mapped, mapped_column
from sqlalchemy.sql import func

class Task(Base):
    __tablename__ = "task"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    name: Mapped[str] = mapped_column(String, nullable=False)
    created_at: Mapped[datetime] = mapped_column(
        DateTime, server_default=func.now(), nullable=False
    )
```
 Note that we are using the Base class we defined before to create our model. For more details on defining SQLAlchemy models see the [ORM quickstart guide](https://docs.sqlalchemy.org/en/20/orm/quickstart.html).

3. Finally, we will add these both to a file `app/models/__init__.py`, which make imports easier and have alembic identify all our models.
```python
from .task import Task
from .base import Base
```


### Connect alembic and sqlalchemy
Now that we have alembic and a sqlalchemy model we need to connect them so alembic can detect changes to our database models and create migration scripts.

1. Update the `alembic/env.py` file
```python
from app.settings import get_settings

config = context.config # this line exists already
settings = get_settings()
url = settings.get_db_connection_string()
config.set_main_option("sqlalchemy.url", url)
```

Here we are importing our settings and setting the database url so alembic can connect to the database.


2. Import our models in `alembic/env.py`. The first if statement should exist already, but we need to configure our base model.
```python
from app.settings import get_settings
from app.models import Base

...

# add your model's MetaData object here for 'autogenerate' support
from app.models import Base
target_metadata = Base.metadata
```


### Create a migration tool
We are ready to create our first migration script. This will be a script that will create our `task` table in our database.

```python
$ docker compose exec api_server sh
$ alembic revision --autogenerate -m "Create task table"
Generating /code/app/alembic/versions/5836f865c326_create_task_table.py ...  done
```
This will create a migration file in `app/alembic/versions` that will contain the changes to our database schema.
The file will look something like this:
```python
def upgrade() -> None:
      # ### commands auto generated by Alembic - please adjust! ###
      op.create_table('task',
      sa.Column('id', sa.BigInteger(), nullable=False),
      sa.Column('name', sa.String(), nullable=False),
      sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
      sa.PrimaryKeyConstraint('id')
      )
      # ### end Alembic commands ###


  def downgrade() -> None:
      # ### commands auto generated by Alembic - please adjust! ###
      op.drop_table('task')
      # ### end Alembic commands ###
```
Alembic migration files are python scripts that contain two functions `upgrade` and `downgrade`. The `upgrade` function is used to apply the migration and the `downgrade` function is used to rollback the migration.


### Run a migration
Let's test out our migration and to do this it's recommended to have two terminal windows open. One for running the migration and the other for examining the database.

1. In the server window  if you haven't ssh'd into the server yet run:
```bash
$ docker compose exec api_server sh
```

2. In a seperate terminal window navigate to the `/data` directory and run:
```bash
$ sqlite3 api.db
$ sqlite> .tables
alembic_version
```

You will see one table alembic versions which alembic uses to know which migrations have been run.

3. Now we can run the migration in the docker server window:
```bash
$ alembic upgrade head
```

4. In the database window check the tables again:
```bash
$ sqlite> .tables
alembic_version  task
$ sqlite> .schema task
CREATE TABLE task (
        id BIGINT NOT NULL,
        name VARCHAR NOT NULL,
        created_at DATETIME DEFAULT (CURRENT_TIMESTAMP) NOT NULL,
        PRIMARY KEY (id)
);
```

You will see that we now have a `task` table in our database.
Alembic created a table based on our python model, pretty cool!

5. Let's rollback the migration, don't worry we will apply it again in the next step:
```bash
$ alembic downgrade -1
```

6. Check the tables again in the database window:
```bash
$ sqlite> .tables
alembic_version
```

The `task` table is gone, we have successfully rolled back the migration.


### Challenge
1. Try creating a new model and running a migration for it.
2. What happens if you try to `alembic upgrade head` twice? or try to run two migrations at the same time?
